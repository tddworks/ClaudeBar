# Contributing to ClaudeBar

Thank you for your interest in contributing to ClaudeBar! We welcome contributions from the community and are grateful for your support.

## Table of Contents

- [Code of Conduct](#code-of-conduct)
- [Getting Started](#getting-started)
- [Development Setup](#development-setup)
- [How to Contribute](#how-to-contribute)
- [Coding Standards](#coding-standards)
- [Testing Guidelines](#testing-guidelines)
- [Pull Request Process](#pull-request-process)
- [Release Process](#release-process)
- [Getting Help](#getting-help)

## Code of Conduct

This project adheres to a [Code of Conduct](CODE_OF_CONDUCT.md). By participating, you are expected to uphold this code. Please report unacceptable behavior to the project maintainers.

## Getting Started

### Prerequisites

- **macOS 15.0 or later** - Required for development and testing
- **Xcode 16 or later** - For iOS/macOS development
- **Swift 6.2+** - Language version
- **Tuist** (optional) - For Xcode project generation with SwiftUI previews

### Installing Dependencies

1. **Install Tuist** (optional, but recommended for Xcode development):
   ```bash
   brew install tuist
   ```

2. **Clone the repository**:
   ```bash
   git clone https://github.com/tddworks/ClaudeBar.git
   cd ClaudeBar
   ```

3. **Build the project**:
   ```bash
   swift build
   ```

## Development Setup

### Command Line Development (Swift Package Manager)

For CLI-based development and testing:

```bash
# Build the project
swift build

# Run all tests
swift test

# Run tests with coverage
swift test --enable-code-coverage

# Run a specific test suite
swift test --filter DomainTests

# Run a specific test
swift test --filter "QuotaMonitorTests/monitor fetches usage from a single provider"

# Run the app
swift run ClaudeBar
```

### Xcode Development (with SwiftUI Previews)

For UI development with SwiftUI previews:

```bash
# Generate Xcode project
tuist generate

# Open in Xcode
open ClaudeBar.xcworkspace
```

After opening in Xcode:
- SwiftUI previews work with `Cmd+Option+Return`
- The project uses `ENABLE_DEBUG_DYLIB` for proper preview support
- Regenerate the project after modifying `Project.swift`

**Important**: `*.xcodeproj` and `*.xcworkspace` are git-ignored since they're generated by Tuist.

## How to Contribute

### Reporting Bugs

If you find a bug, please [open an issue](https://github.com/tddworks/ClaudeBar/issues/new) with:

- A clear, descriptive title
- Steps to reproduce the issue
- Expected behavior vs. actual behavior
- macOS version and ClaudeBar version
- Relevant logs or screenshots
- Any other context that might help

### Requesting Features

Feature requests are welcome! Please [open an issue](https://github.com/tddworks/ClaudeBar/issues/new) with:

- A clear description of the feature
- The problem it solves
- Any alternative solutions you've considered
- Mockups or examples (if applicable)

### Contributing Code

1. **Fork the repository** and create a feature branch:
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make your changes** following our [coding standards](#coding-standards)

3. **Write tests** for your changes (see [Testing Guidelines](#testing-guidelines))

4. **Run tests** to ensure nothing breaks:
   ```bash
   swift test
   ```

5. **Commit your changes** with clear, descriptive messages:
   ```bash
   git commit -m "feat: add support for new AI provider"
   ```

6. **Push to your fork**:
   ```bash
   git push origin feature/your-feature-name
   ```

7. **Open a Pull Request** against the `main` branch

## Coding Standards

### Architecture

ClaudeBar follows a **layered architecture** with protocol-based dependency injection:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   App Layer                     â”‚
â”‚     SwiftUI Views + @Observable AppState        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Domain Layer                    â”‚
â”‚  Models: UsageQuota, UsageSnapshot, QuotaStatus â”‚
â”‚  Protocols: UsageProbe, StatusChangeObserver    â”‚
â”‚  Services: QuotaMonitor (Actor)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Infrastructure Layer               â”‚
â”‚  Probes: Claude, Codex, Gemini, Copilot probes  â”‚
â”‚  Adapters: Pure 3rd-party wrappers (no coverage)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Principles

1. **Protocol-Based Dependency Injection**
   - Domain defines protocols (`UsageProbe`, `StatusChangeObserver`)
   - Infrastructure provides implementations
   - Use `@Mockable` macro for test doubles

2. **Rich Domain Models**
   - Business logic lives in domain models, not ViewModels
   - No ViewModel layer - SwiftUI views directly consume domain models

3. **Actor-Based Concurrency**
   - Use Swift actors for thread-safe state management
   - `QuotaMonitor` is an actor for managing quota state

4. **Testability**
   - Protocols with `@Mockable` for easy mocking
   - Adapters folder for pure 3rd-party wrappers (excluded from coverage)
   - Parsing logic as static/internal methods for direct testing

### Swift Style Guide

- Follow [Swift API Design Guidelines](https://swift.org/documentation/api-design-guidelines/)
- Use clear, descriptive names for types, functions, and variables
- Prefer `let` over `var` when possible
- Use Swift's type inference where it improves readability
- Keep functions small and focused on a single responsibility
- Use meaningful commit messages following [Conventional Commits](https://www.conventionalcommits.org/)

### Adding a New AI Provider

To add support for a new AI provider:

1. **Create a provider class** implementing `AIProvider` in `Sources/Domain/Provider/`
2. **Create a probe** in `Sources/Infrastructure/CLI/` implementing `UsageProbe`
3. **Register the provider** in `ClaudeBarApp.init()`
4. **Add parsing tests** in `Tests/InfrastructureTests/CLI/`
5. **Update documentation** (README.md, this guide)

See [CLAUDE.md](CLAUDE.md) for detailed architecture guidance.

## Testing Guidelines

### Testing Framework

ClaudeBar uses **Swift Testing** (not XCTest):
- Use `@Test` and `@Suite` attributes
- Use `#expect` for assertions
- Use `@Mockable` from the Mockable package for protocol mocks

### Test Structure

```swift
import Testing
@testable import Domain

@Suite("QuotaMonitor Tests")
struct QuotaMonitorTests {
    @Test("monitor fetches usage from a single provider")
    func testFetchUsage() async throws {
        // Arrange
        let mockProbe = MockUsageProbe()
        
        // Act
        let result = try await mockProbe.fetchUsage()
        
        // Assert
        #expect(result != nil)
    }
}
```

### Coverage Guidelines

- Write tests for all new features and bug fixes
- Aim for high test coverage in Domain and Infrastructure layers
- Adapters folder is excluded from coverage (pure 3rd-party wrappers)
- Run tests with coverage: `swift test --enable-code-coverage`

### Running Tests

```bash
# Run all tests
swift test

# Run specific test suite
swift test --filter DomainTests

# Run specific test
swift test --filter "QuotaMonitorTests/monitor fetches usage"

# Run with coverage
swift test --enable-code-coverage
```

## Pull Request Process

### Before Submitting

1. **Ensure tests pass**: Run `swift test` locally
2. **Check code quality**: Ensure your code follows our standards
3. **Update documentation**: Update README.md or other docs if needed
4. **Write clear commit messages**: Follow Conventional Commits format

### PR Guidelines

- **Title**: Use a clear, descriptive title (e.g., "feat: add Gemini quota support")
- **Description**: Explain what changes you made and why
- **Link issues**: Reference any related issues (e.g., "Fixes #123")
- **Screenshots**: Include screenshots for UI changes
- **Breaking changes**: Clearly mark breaking changes

### Commit Message Format

We follow [Conventional Commits](https://www.conventionalcommits.org/):

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting, etc.)
- `refactor`: Code refactoring
- `test`: Adding or updating tests
- `chore`: Maintenance tasks

**Examples**:
```
feat(copilot): add GitHub Copilot quota monitoring
fix(gemini): handle empty API response correctly
docs: update installation instructions in README
```

### Review Process

1. A maintainer will review your PR
2. Address any feedback or requested changes
3. Once approved, a maintainer will merge your PR
4. Your changes will be included in the next release

## Release Process

Releases are automated via GitHub Actions. See [docs/RELEASE_SETUP.md](docs/RELEASE_SETUP.md) for detailed setup instructions.

### Creating a Release

1. **Update CHANGELOG.md** with release notes
2. **Commit the changelog**:
   ```bash
   git add CHANGELOG.md
   git commit -m "docs: add release notes for v1.0.0"
   git push origin main
   ```
3. **Create and push a tag**:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

The CI workflow will automatically:
- Build the app for Intel and Apple Silicon
- Sign with Developer ID certificate
- Notarize with Apple
- Create a GitHub release with DMG and ZIP
- Update appcast.xml for Sparkle auto-updates

### Versioning

We use [Semantic Versioning](https://semver.org/):
- **MAJOR**: Breaking changes
- **MINOR**: New features (backward compatible)
- **PATCH**: Bug fixes (backward compatible)

Supported formats:
- `X.Y.Z` - Stable release (e.g., `1.0.0`)
- `X.Y.Z-beta.N` - Beta release (e.g., `1.0.0-beta.1`)
- `X.Y.Z-alpha.N` - Alpha release (e.g., `2.0.0-alpha.1`)
- `X.Y.Z-rc.N` - Release candidate (e.g., `2.0.0-rc.1`)

## Getting Help

- **Documentation**: Check [README.md](README.md), [CLAUDE.md](CLAUDE.md), and [docs/](docs/)
- **Issues**: Search [existing issues](https://github.com/tddworks/ClaudeBar/issues) or create a new one
- **Discussions**: Start a [discussion](https://github.com/tddworks/ClaudeBar/discussions) for questions
- **Technical guides**:
  - [Sparkle Setup](docs/SPARKLE_SETUP.md) - Auto-update configuration
  - [Release Setup](docs/RELEASE_SETUP.md) - Release workflow and secrets

## Additional Resources

- [Swift Documentation](https://swift.org/documentation/)
- [SwiftUI Documentation](https://developer.apple.com/documentation/swiftui)
- [Tuist Documentation](https://docs.tuist.io)
- [Sparkle Documentation](https://sparkle-project.org/documentation/)

---

Thank you for contributing to ClaudeBar! ğŸ‰
