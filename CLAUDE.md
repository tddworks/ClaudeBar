# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ClaudeBar is a macOS menu bar application that monitors AI coding assistant usage quotas (Claude, Codex, Gemini, GitHub Copilot, Antigravity). It probes CLI tools to fetch quota information and displays it in a menu bar interface with system notifications for status changes.

## Build & Test Commands

The project uses [Tuist](https://tuist.io) for dependency management and Xcode project generation.

### Quick Start

```bash
# Install Tuist (if not installed)
brew install tuist

# Install dependencies
tuist install

# Generate Xcode project and open
tuist generate
open ClaudeBar.xcworkspace
```

### Build & Test

```bash
# Build the project
tuist build

# Run all tests
tuist test

# Run a specific test target
tuist test DomainTests

# Run tests with coverage
tuist test --result-bundle-path TestResults.xcresult -- -enableCodeCoverage YES

# Build release configuration
tuist build -- -configuration Release
```

**Key files:**
- `Project.swift` - Tuist project definition (targets, dependencies, build settings)
- `Tuist/Package.swift` - External dependency declarations
- `Tuist.swift` - Tuist configuration

**Note:** `*.xcodeproj` and `*.xcworkspace` are git-ignored since they're generated by Tuist.

## Architecture

> **Full documentation:** [docs/architecture/ARCHITECTURE.md](docs/architecture/ARCHITECTURE.md)

The project follows a **layered architecture** with `QuotaMonitor` as the single source of truth:

| Layer | Location | Purpose |
|-------|----------|---------|
| **Domain** | `Sources/Domain/` | Pure business logic, rich models, protocols |
| **Infrastructure** | `Sources/Infrastructure/` | Probes, storage, adapters, network |
| **App** | `Sources/App/` | SwiftUI views consuming domain directly |

### Key Patterns

- **Single Source of Truth** - `QuotaMonitor` owns all provider state
- **ISP (Interface Segregation)** - Provider-specific repository sub-protocols:
  - `ProviderSettingsRepository` (base) - `isEnabled` for simple providers
  - `ZaiSettingsRepository` extends base - adds Z.ai config path + env var
  - `CopilotSettingsRepository` extends base - adds env var + credentials
- **SRP (Single Responsibility)** - Each provider owns only its concerns
- **Protocol-Based DI** - `@Mockable` protocols enable testing without real CLI/network
- **Chicago School TDD** - Tests verify state changes, not method calls
- **No ViewModel/AppState** - Views consume `QuotaMonitor` directly

### Repository Protocol Hierarchy (ISP)

```
ProviderSettingsRepository (base)
├── isEnabled(), setEnabled()
│
├── ZaiSettingsRepository: ProviderSettingsRepository
│   ├── zaiConfigPath(), setZaiConfigPath()
│   └── glmAuthEnvVar(), setGlmAuthEnvVar()
│
└── CopilotSettingsRepository: ProviderSettingsRepository
    ├── copilotAuthEnvVar(), setCopilotAuthEnvVar()
    └── GitHub credentials: save/get/delete token & username
```

**Provider Dependencies:**
| Provider | Repository Type |
|----------|----------------|
| Claude, Codex, Gemini, Antigravity | `ProviderSettingsRepository` |
| Z.ai | `ZaiSettingsRepository` |
| Copilot | `CopilotSettingsRepository` |

### Theme System

> **Full documentation:** [docs/architecture/THEME_DESIGN.md](docs/architecture/THEME_DESIGN.md)

The app uses a **protocol-based theme system** (`AppThemeProvider`) for pluggable themes:

```
Sources/App/Theme/
├── AppThemeProvider.swift      # Protocol definition
├── ThemeRegistry.swift         # Theme management
├── ThemeEnvironment.swift      # SwiftUI environment key
└── Themes/
    ├── DarkTheme.swift         # Purple-pink glassmorphism
    ├── LightTheme.swift        # Light mode variant
    ├── CLITheme.swift          # Terminal aesthetic
    └── ChristmasTheme.swift    # Festive with snowfall
```

**Adding a New Theme:**
1. Create `Sources/App/Theme/Themes/MyTheme.swift` implementing `AppThemeProvider`
2. Register in `ThemeRegistry.registerBuiltInThemes()`
3. Add case to `ThemeMode` enum in `Theme.swift`

### Adding a New AI Provider

Use the **add-provider** skill to guide you through adding new AI providers following TDD patterns:

```
Tell Claude Code: "I want to add a new provider for [ProviderName]"
```

The skill will guide you through:

1. **Parsing Tests** → Create tests for API/CLI response parsing first
2. **Probe Behavior Tests** → Test detection and error handling with mocks
3. **Probe Implementation** → Implement `UsageProbe` in `Sources/Infrastructure/CLI/`
4. **Provider Class** → Create `AIProvider` in `Sources/Domain/Provider/`
5. **Registration** → Add to `ClaudeBarApp.init()` providers array

**Repository Selection (ISP):**
- **Simple provider** (no special config) → Use base `ProviderSettingsRepository`
- **Provider with config/credentials** → Create a new sub-protocol extending base

```swift
// If your provider needs special settings, create a sub-protocol:
public protocol MyProviderSettingsRepository: ProviderSettingsRepository {
    func mySpecialConfig() -> String
    func setMySpecialConfig(_ value: String)
}

// Then add implementation to UserDefaultsProviderSettingsRepository
```

**Skill location:** `.claude/skills/add-provider/SKILL.md`

**Reference implementations:**
- `AntigravityProvider` - Simple provider using base `ProviderSettingsRepository`
- `ZaiProvider` - Extended with `ZaiSettingsRepository` for config path
- `CopilotProvider` - Extended with `CopilotSettingsRepository` for config + credentials

## Assets

The project uses a standard Xcode asset catalog for images:

```
Sources/App/Resources/
├── Assets.xcassets/           # Used at runtime
│   ├── AppIcon.appiconset/    # App icon (all sizes)
│   ├── AppLogo.imageset/      # App logo
│   ├── ClaudeIcon.imageset/   # Provider icons (PNG @1x, @2x, @3x)
│   ├── CodexIcon.imageset/
│   ├── CopilotIcon.imageset/
│   ├── GeminiIcon.imageset/
│   └── AntigravityIcon.imageset/
├── ClaudeIcon.svg             # Source SVG files (kept for reference)
├── CodexIcon.svg
├── CopilotIcon.png
├── GeminiIcon.svg
└── AntigravityIcon.svg
```

- **Runtime**: PNGs from `Assets.xcassets` loaded via `NSImage(named:)`
- **Source**: SVGs kept as original files for future regeneration

## Versioning & Release

### How Version Updates Work (with Tuist)

The release workflow updates version before Tuist generates the project:

```
1. GitHub Action triggered (tag v1.0.0 or manual input)
2. Update Info.plist ← PlistBuddy sets CFBundleShortVersionString
3. tuist generate   ← Reads updated Info.plist
4. xcodebuild       ← Builds app with correct version
5. Sparkle appcast  ← Generated with version for auto-updates
```

**Key files:**
- `Sources/App/Info.plist` - Source of truth for version (`CFBundleShortVersionString`, `CFBundleVersion`)
- `Project.swift` - References Info.plist: `infoPlist: .file(path: "Sources/App/Info.plist")`

### Manual Version Update (Local Development)

```bash
# Update version in Info.plist
/usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0.0" Sources/App/Info.plist
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion 1" Sources/App/Info.plist

# Regenerate Xcode project
tuist generate
```

### Creating a Release

```bash
# Tag and push to trigger release workflow
git tag v1.0.0
git push origin v1.0.0
```

Or use the manual workflow dispatch in GitHub Actions with version input.

## Logging

The app uses a **dual-output logging system** via `AppLog` in `Sources/Infrastructure/Logging/`:

- **OSLog** (for developers): Full privacy controls, visible in Console.app
- **File** (for users): Persistent logs at `~/Library/Logs/ClaudeBar/ClaudeBar.log`

### AppLog Categories

```swift
AppLog.monitor        // QuotaMonitor operations
AppLog.providers      // AI provider lifecycle  
AppLog.probes         // CLI probe execution
AppLog.network        // HTTP requests/responses
AppLog.credentials    // Token management (redact sensitive data!)
AppLog.ui             // SwiftUI view lifecycle
AppLog.notifications  // System notifications
AppLog.updates        // Sparkle updates
```

### Log Levels and Output

| Level | Method | OSLog | File | Use Case |
|-------|--------|-------|------|----------|
| `debug` | `.debug()` | ✅ | ❌ | Development diagnostics (too verbose for file) |
| `info` | `.info()` | ✅ | ✅ | Informational events |
| `notice` | `.notice()` | ✅ | ✅ | Significant events |
| `warning` | `.warning()` | ✅ | ✅ | Potential issues |
| `error` | `.error()` | ✅ | ✅ | Recoverable errors |

### Privacy Rules

Since `AppLog` uses simple String parameters (not OSLog interpolation), you must manually redact sensitive data:

```swift
// ✅ Correct - redact sensitive data
AppLog.credentials.info("Token refreshed for provider")
AppLog.probes.error("Probe failed: \(error.localizedDescription)")

// ❌ Wrong - exposes secrets in file log
AppLog.credentials.info("Token: \(accessToken)")
```

For sensitive debugging that needs OSLog privacy controls, use OSLog directly.

### File Logging Details

- **Location**: `~/Library/Logs/ClaudeBar/ClaudeBar.log`
- **Rotation**: Rotates to `ClaudeBar.old.log` at 5MB
- **Format**: `[YYYY-MM-DD HH:MM:SS] [LEVEL] [category] message`
- **Access**: Settings → "Open Logs Folder" button

### Viewing Logs

**File logs (for users):**
```bash
# Open in Finder (or use Settings → Open Logs Folder)
open ~/Library/Logs/ClaudeBar/

# Tail the log
tail -f ~/Library/Logs/ClaudeBar/ClaudeBar.log
```

**OSLog (for developers):**
```bash
# Console.app filter
subsystem:com.tddworks.ClaudeBar

# Terminal - show all levels (including debug)
log show --predicate 'subsystem == "com.tddworks.ClaudeBar"' --info --debug --last 1h

# Terminal - errors only
log show --predicate 'subsystem == "com.tddworks.ClaudeBar" AND messageType == error' --last 1h

# Live stream (for debugging)
log stream --predicate 'subsystem == "com.tddworks.ClaudeBar"' --info --debug
```

### Debugging Probe Issues

When a probe fails (e.g., `claude /usage`), all errors are logged with context:

```bash
# File log - grep for probe issues
grep -i "probe" ~/Library/Logs/ClaudeBar/ClaudeBar.log

# OSLog - probe-specific logs
log show --predicate 'subsystem == "com.tddworks.ClaudeBar" AND category == "probes"' --info --debug --last 1h
```

Common error patterns logged:
- `"Claude probe failed: token has expired"` → Re-login required
- `"Claude probe blocked: folder trust required"` → Trust the folder in Claude CLI
- `"Codex probe failed: data not available yet"` → Wait for Codex to sync
- `"Gemini probe failed: no access token"` → Re-authenticate with Gemini CLI
- `"Antigravity probe failed: server not found"` → Ensure Antigravity app is running locally

## Dependencies

- **Sparkle**: Auto-update framework for macOS
- **Mockable**: Protocol mocking for tests via Swift macros
- **Tuist**: Xcode project generation for SwiftUI previews (`ENABLE_DEBUG_DYLIB`)
